const Sale = require("../models/Sale");
const Medicine = require("../models/Medicine");

function startOfDay(d = new Date()) {
  const x = new Date(d);
  x.setHours(0, 0, 0, 0);
  return x;
}

exports.getCards = async (_req, res) => {
  try {
    const today = startOfDay();
    const todaySales = await Sale.find({ createdAt: { $gte: today } });
    const allSales = await Sale.find();
    const medicines = await Medicine.find();

    const todayRevenue = todaySales.reduce((a, s) => a + Number(s.total || 0), 0);
    const todayProfit = todaySales.reduce((a, s) => a + Math.max(0, Number(s.total || 0) - Number(s.subtotal || 0) * 0.85), 0);
    const creditOutstanding = allSales.reduce((a, s) => a + Math.max(0, Number(s.due || 0)), 0);
    const lowStockCount = medicines.filter((m) => Number(m.stock || 0) < 10).length;

    return res.json({
      success: true,
      data: { todayRevenue, todayProfit, creditOutstanding, lowStockCount, expiryAlert: 0 },
    });
  } catch (error) {
    console.error("getCards error:", error);
    return res.status(500).json({ success: false, message: "Failed to load dashboard cards" });
  }
};

exports.getMonthlyRevenue = async (_req, res) => {
  try {
    const now = new Date();
    const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
    const lastMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);

    const sales = await Sale.find({ createdAt: { $gte: lastMonthStart } });
    let currentMonth = 0;
    let lastMonth = 0;
    sales.forEach((s) => {
      const d = new Date(s.createdAt);
      if (d >= currentMonthStart) currentMonth += Number(s.total || 0);
      else lastMonth += Number(s.total || 0);
    });

    const growthPercent = lastMonth === 0 ? (currentMonth > 0 ? 100 : 0) : ((currentMonth - lastMonth) / lastMonth) * 100;
    return res.json({
      success: true,
      data: { currentMonth, lastMonth, growthPercent, direction: growthPercent >= 0 ? "up" : "down" },
    });
  } catch (error) {
    console.error("getMonthlyRevenue error:", error);
    return res.status(500).json({ success: false, message: "Failed to load monthly revenue" });
  }
};

exports.getTopMedicines = async (_req, res) => {
  try {
    const sales = await Sale.find();
    const map = new Map();
    sales.forEach((s) => {
      (s.items || []).forEach((i) => {
        const k = i.name || "Medicine";
        map.set(k, (map.get(k) || 0) + Number(i.quantity || 0));
      });
    });

    const rows = Array.from(map.entries())
      .map(([name, total_quantity]) => ({ name, total_quantity }))
      .sort((a, b) => b.total_quantity - a.total_quantity)
      .slice(0, 5);

    return res.json({ success: true, data: rows });
  } catch (error) {
    console.error("getTopMedicines error:", error);
    return res.status(500).json({ success: false, message: "Failed to load top medicines" });
  }
};
